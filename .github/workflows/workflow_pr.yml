name: "[Workflow] Pull Request"

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - terraform/**
      - .github/workflows/workflow_terraform.yml

permissions:
  actions: read
  contents: write
  id-token: write

env:
  BUILD_DIR: ./builds/
  PRERELEASE: "true"
  PATH_TO_LIVE: "false"

# jobs
jobs:
  # setup provides all vars used in the workflow to make it easier
  setup:
    name: "Set variables"
    runs-on: ubuntu-latest
    outputs:
      git_sha: ${{ steps.revhead.outputs.gitsha}}
      # SEMVER & BRANCH NAMES
      semver_tag: ${{ steps.semver_tag.outputs.created_tag }}
    steps:
      # Check the code base
      - name: "Checkout"
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true
      # generate semver
      # TODO: This is using an older version of self,
      - name: "Generate semver tag and release"
        id: semver_tag
        uses: ministryofjustice/opg-github-actions/.github/actions/semver-tag@c9c5dfb290b8f614df0884928c521165ba83d630 # v3.1.4
        with:
          prerelease: ${{ env.PRERELEASE }}
          releases_enabled: false
          with_v: true
      # get the git sha
      - name: "Get git sha"
        id: revhead
        run: |
          sha=$(git rev-parse HEAD)
          echo "gitsha=${sha}" >> $GITHUB_OUTPUT


  # run all the tests
  tests:
    name: "Run Go Tests"
    needs:
      - setup
    runs-on: ubuntu-latest
    steps:
      # checkout self
      - name: "Checkout"
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true
      # setup the go version and pull from cache etc
      - name: "Setup go"
        id: setup_go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          cache: false
          go-version-file: './go.mod'
      # run tests
      - name: "Run tests"
        id: run_tests
        shell: bash
        env:
          GITHUB_TOKEN: ${{ inputs.github_token }}
        run: |
          go mod tidy
          go test -count=1 -cover -covermode=atomic ./...

  # Build all binaries and attach to this release tag
  build_and_release:
    name: "Build & Create release"
    runs-on: ubuntu-latest
    needs:
      - setup
      - tests
    steps:
      # checkout self
      - name: "Checkout"
        id: checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          fetch-tags: true
      # build the branch-name command
      - name: "Build command [branch-name]"
        uses: ./.github/actions/build-go
        with:
          name: branch-name
          source: ./action/cmd/branch-name/
          destination: ${{ env.BUILD_DIR }}
      # build the tf version command
      - name: "Build command [terraform-version]"
        uses: ./.github/actions/build-go
        with:
          name: terraform-version
          source: ./action/cmd/terraform-version/
          destination: ${{ env.BUILD_DIR }}
      # create a release, attaching the build binaries to it
      - name: "Create release [${{ needs.setup.outputs.semver_tag }}]"
        env:
          GH_TOKEN: ${{ github.token }}
          pre: ${{ env.PRERELEASE == 'true' && '--prerelease' || '' }}
          latest:  ${{ env.PATH_TO_LIVE == 'true' && '--latest=true' || '--latest=false' }}
          tag: ${{ needs.setup.outputs.semver_tag }}
        run: |
          gh release create ${{ env.tag }} ${{ env.BUILD_DIR }}/* \
            ${{ env.pre }} ${{ env.latest }} --verify-tag \
            -t ${{ env.tag }} \
            --notes-from-tag
  # final step
  end:
    name: 'End'
    runs-on: 'ubuntu-latest'
    needs:
      - build_and_release
    steps:
      - id: end
        name: End
        run: echo "End"
